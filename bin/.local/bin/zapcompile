#!/bin/zsh
# ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
#  Zap Plugin Compiler
#  Compiles plugin files for ~2-3ms startup improvement
#  Usage: zapcompile [--force] [--quiet] [--silent]
# ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ

function zapcompile() {
    local plugin_dir="${XDG_DATA_HOME:-$HOME/.local/share}/zap/plugins"
    local compiled=0
    local quiet=0
    local silent=0
    
    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --force) local force=1; shift ;;
            -q|--quiet) quiet=1; shift ;;
            -s|--silent) silent=1; shift ;;
            *) shift ;;
        esac
    done
    
    [[ -d "$plugin_dir" ]] || { echo "‚ùå Plugin directory not found"; return 1; }
    
    [[ -d "$plugin_dir" ]] || { (( silent )) || echo "‚ùå Plugin directory not found"; return 1; }
    
    # Force recompile
    if [[ -n $force ]]; then
        (( quiet || silent )) || echo "üóëÔ∏è  Removing all compiled files..."
        rm -f "$plugin_dir"/**/*.zwc(N)
        (( quiet || silent )) || echo "‚úÖ Cleared. Recompiling..."
    fi
    
    (( quiet || silent )) || echo "üî® Compiling zap plugin files..."
    
    setopt local_options extended_glob
    
    for file in "$plugin_dir"/**/*.(zsh|plugin.zsh|zsh-theme|zsh.inc)(-.N); do
        # Skip test directories and unreadable files
        [[ "$file" == */(test|tests)/* ]] && continue
        [[ -r "$file" && -w "${file:h}" ]] || continue
        
        # Compile if missing or outdated
        if [[ ! -f "${file}.zwc" || "$file" -nt "${file}.zwc" ]]; then
            # Direct compile with -U (unlink if exists) and -M (ignore timestamps)
            if zcompile -U "${file}.zwc" "$file" 2>/dev/null; then
                ((compiled++))
            else
                (( silent )) || echo "‚ö†Ô∏è  Failed: ${file:t}"
            fi
        fi
    done
    
    if (( silent )); then
        : # No output
    elif (( quiet )); then
        [[ $compiled -gt 0 ]] && echo "‚úÖ Compiled $compiled file(s)"
    else
        [[ $compiled -gt 0 ]] && echo "‚ú® Compiled $compiled file(s)" || echo "‚úÖ All files up to date"
    fi
    
    unfunction zapcompile
}

zapcompile "$@"